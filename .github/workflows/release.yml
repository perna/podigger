name: Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      
      - name: Install Commitizen
        run: |
          python -m pip install --upgrade pip
          pip install commitizen>=3.13.0
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Check for version bump
        id: check_bump
        run: |
          cd backend
          
          # Get current version
          CURRENT_VERSION=$(cz version --project)
          echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          
          # Check if there are commits that require a version bump
          if cz bump --dry-run --yes 2>&1 | grep -q "No commits found"; then
            echo "should_bump=false" >> "$GITHUB_OUTPUT"
            echo "No commits requiring version bump found"
          else
            echo "should_bump=true" >> "$GITHUB_OUTPUT"
            echo "Commits requiring version bump found"
          fi
      
      - name: Bump version
        if: steps.check_bump.outputs.should_bump == 'true'
        id: bump
        run: |
          cd backend
          
          # Determine bump type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.bump_type }}" != "auto" ]; then
            BUMP_TYPE="${{ github.event.inputs.bump_type }}"
            cz bump --increment $BUMP_TYPE --yes
          else
            cz bump --yes
          fi
          
          # Get new version
          NEW_VERSION=$(cz version --project)
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Bumped version to $NEW_VERSION"
      
      - name: Push changes
        if: steps.check_bump.outputs.should_bump == 'true'
        run: |
          git push origin HEAD:${{ github.ref_name }}
          git push --tags
      
      - name: Extract changelog for release
        if: steps.check_bump.outputs.should_bump == 'true'
        id: changelog
        run: |
          # Extract the latest version section from CHANGELOG.md
          VERSION="${{ steps.bump.outputs.new_version }}"
          
          # Get changelog content between the latest version and the previous one
          CHANGELOG_CONTENT=$(awk "/## \[?${VERSION}\]?/,/## \[?[0-9]/" CHANGELOG.md | sed '1d;$d')
          
          # If empty, use a default message
          if [ -z "$CHANGELOG_CONTENT" ]; then
            CHANGELOG_CONTENT="See CHANGELOG.md for details"
          fi
          
          # Save to file for multiline output
          echo "$CHANGELOG_CONTENT" > /tmp/changelog.txt
          echo "changelog_file=/tmp/changelog.txt" >> "$GITHUB_OUTPUT"
      
      - name: Create GitHub Release
        if: steps.check_bump.outputs.should_bump == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.bump.outputs.new_version }}
          release_name: Release v${{ steps.bump.outputs.new_version }}
          body_path: ${{ steps.changelog.outputs.changelog_file }}
          draft: false
          prerelease: false
      
      - name: Summary
        if: steps.check_bump.outputs.should_bump == 'true'
        run: |
          echo "### ðŸš€ Release Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Previous Version:** ${{ steps.check_bump.outputs.current_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**New Version:** ${{ steps.bump.outputs.new_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Tag:** v${{ steps.bump.outputs.new_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… Release created successfully!" >> "$GITHUB_STEP_SUMMARY"
      
      - name: No release needed
        if: steps.check_bump.outputs.should_bump == 'false'
        run: |
          echo "### â„¹ï¸ No Release Needed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "No commits requiring a version bump were found." >> "$GITHUB_STEP_SUMMARY"
          echo "Current version: ${{ steps.check_bump.outputs.current_version }}" >> "$GITHUB_STEP_SUMMARY"
